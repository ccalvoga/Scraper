<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autoconsumo Scraper - Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #218838;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Autoconsumo Scraper - Modo Test</h1>

        <div id="status">Estado: Cargando...</div>

        <h2>Controles</h2>
        <button id="test-btn">Test BotÃ³n</button>
        <button id="start-scrape">Iniciar Scraping</button>

        <h2>Editor de Fuentes</h2>
        <textarea id="fuentes-editor" placeholder="Cargando fuentes.csv..."></textarea>
        <button id="save-fuentes">Guardar Fuentes</button>

        <h2>Logs</h2>
        <textarea id="log-output" readonly>Esperando logs...</textarea>
    </div>

    <script>
        console.log('JavaScript cargado correctamente');

        document.getElementById('status').textContent = 'Estado: JavaScript activo âœ…';

        // Test button
        document.getElementById('test-btn').addEventListener('click', () => {
            alert('Â¡Los botones funcionan! âœ…');
        });

        // Load fuentes
        fetch('/api/files/fuentes.csv')
            .then(response => response.json())
            .then(data => {
                if (data.content) {
                    document.getElementById('fuentes-editor').value = data.content;
                    console.log('Fuentes cargadas');
                }
            })
            .catch(error => {
                console.error('Error cargando fuentes:', error);
                document.getElementById('fuentes-editor').value = 'Error: ' + error.message;
            });

        // Save fuentes
        document.getElementById('save-fuentes').addEventListener('click', () => {
            const content = document.getElementById('fuentes-editor').value;

            fetch('/api/files/fuentes.csv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… Guardado correctamente');
                } else {
                    alert('âŒ Error: ' + data.error);
                }
            })
            .catch(error => alert('âŒ Error: ' + error.message));
        });

        // Start scraping
        document.getElementById('start-scrape').addEventListener('click', () => {
            document.getElementById('log-output').value = 'Iniciando scraping...\n';

            fetch('/api/scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    max_depth: 3,
                    crawl_strategy: 'continue',
                    file_types: ['documents'],
                    download_scope: 'same-domain',
                    path_restriction: 'base-path',
                    save_page_text: true,
                    save_html: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    document.getElementById('log-output').value += data.message + '\n';
                    alert('âœ… ' + data.message);
                    startLogPolling();
                } else {
                    document.getElementById('log-output').value += 'Error: ' + data.error + '\n';
                    alert('âŒ ' + data.error);
                }
            })
            .catch(error => {
                document.getElementById('log-output').value += 'Error: ' + error.message + '\n';
                alert('âŒ Error: ' + error.message);
            });
        });

        // Poll logs
        function startLogPolling() {
            setInterval(() => {
                fetch('/api/logs')
                    .then(response => response.json())
                    .then(data => {
                        if (data.content) {
                            document.getElementById('log-output').value = data.content;
                            // Auto-scroll
                            document.getElementById('log-output').scrollTop =
                                document.getElementById('log-output').scrollHeight;
                        }
                    })
                    .catch(error => console.error('Error polling logs:', error));
            }, 3000);
        }

        console.log('Todos los event listeners configurados âœ…');
    </script>
</body>
</html>
